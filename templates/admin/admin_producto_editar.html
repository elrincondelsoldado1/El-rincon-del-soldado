{% extends "base.html" %}
{% block title %}Editar producto #{{ p.id }}{% endblock %}

{% block extra_head %}
<style>
  .pill-check{display:none;}
  .pill-label{
    display:inline-flex;align-items:center;gap:.4rem;
    border:1px solid rgba(212,175,55,.35);
    background:rgba(212,175,55,.08);
    color:#f5f5f5;border-radius:999px;padding:.35rem .65rem;font-size:.9rem;cursor:pointer;
  }
  .pill-check:checked + .pill-label{
    background:linear-gradient(to right,#7a6600,#d4af37);
    color:#121212;border-color:#d4af37;
  }
  .allergen-badge{
    display:inline-flex;align-items:center;justify-content:center;
    width:22px;height:22px;border-radius:999px;border:1px solid var(--primary,#d4af37);
    background:rgba(212,175,55,.10);color:#f5f5f5;font-size:.85rem;line-height:1;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <h1 class="text-gold fw-bold mb-4">Editar producto #{{ p.id }}</h1>
  
  <form method="POST" enctype="multipart/form-data" class="auth-form" id="form-edit">
    <div class="mb-3">
      <label class="input-label">Categor√≠a</label>
      <select name="categoria" class="form-select" required>
        {% for c in categorias %}
        <option value="{{ c }}" {{ 'selected' if c==p.categoria else '' }}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    
    <div class="mb-3">
      <label class="input-label">Nombre</label>
      <input type="text" name="nombre" class="form-control" value="{{ p.nombre }}" required>
    </div>
    
    <div class="mb-3">
      <label class="input-label">Descripci√≥n</label>
      <textarea name="descripcion" class="form-control" rows="4">{{ p.descripcion }}</textarea>
    </div>
    
    <div class="mb-3">
      <label class="input-label">Precio (‚Ç¨)</label>
      <input type="number" step="0.01" min="0" name="precio" class="form-control" value="{{ '%.2f'|format(p.precio) }}" required>
    </div>
    
    <div class="mb-4">
      <label class="input-label d-block">Imagen</label>
      {% if p.imagen %}
      {% if p.imagen.startswith('http') %}
      <img src="{{ p.imagen }}" alt="img" style="height:64px;border-radius:8px;" class="mb-2">
      {% else %}
      <img src="{{ url_for('static', filename='img/' ~ p.imagen) }}" alt="img" style="height:64px;border-radius:8px;" class="mb-2">
      {% endif %}
      {% endif %}
      
      <input type="file" name="imagen" accept="image/*" class="form-control">
      <div class="form-text">Si no seleccionas archivo, se mantiene la imagen actual.</div>
    </div>
    
    <!-- Al√©rgenos -->
    <div class="mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <label class="input-label m-0">Al√©rgenos</label>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-sm btn-warning" id="btn-sugerir">Sugerir</button>
          <button type="button" class="btn btn-sm btn-secondary" id="btn-limpiar">Limpiar</button>
        </div>
      </div>
      <div class="d-flex flex-wrap gap-2">
        {% set sel = p.alergenos or [] %}
        {% for a in alergenos %}
        {% set checked = a in sel %}
        <input class="pill-check" type="checkbox" id="alg_{{ loop.index }}" name="alergenos" value="{{ a }}" {{ 'checked' if checked else '' }}>
        <label class="pill-label" for="alg_{{ loop.index }}">
          <span class="allergen-badge">
            {% set k=a|lower %}
            {% if k=='gluten' %}üåæ{% elif k=='lactosa' %}ü•õ{% elif k=='huevo' %}ü•ö{% elif k=='frutos secos' %}ü•ú{% elif k=='marisco' %}ü¶ê{% elif k=='pescado' %}üêü{% elif k=='soja' %}ü´ò{% elif k=='sesamo' %}SE{% elif k=='apio' %}ü•¨{% elif k=='mostaza' %}MO{% else %}!{% endif %}
          </span>
          <span>{{ a|title }}</span>
        </label>
        {% endfor %}
      </div>
    </div>
    
    <!-- Estado -->
    <div class="mb-3">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="sw-agotado" name="agotado" {{ 'checked' if p.agotado else '' }}>
        <label class="form-check-label" for="sw-agotado">Marcar como Agotado</label>
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="sw-visible" name="visible" {{ 'checked' if p.visible else '' }}>
        <label class="form-check-label" for="sw-visible">Visible en la carta</label>
      </div>
    </div>
    
    <div class="d-flex gap-2">
      <button class="btn btn-military">Guardar cambios</button>
      <a href="{{ url_for('admin_index', seccion='carta') }}" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>
</div>

<script>
  // Reglas simples para sugerir al√©rgenos a partir del nombre/descripcion
  const reglas = [
  { k: /(pan|harina|rebozad|masa|pasta|gnocchi|pizza|empanad|gallet|bizcocho|trigo|cebada|centeno)/i, alg: 'gluten' },
  { k: /(queso|leche|nata|mantequilla|yogur|lactosa|bechamel|mozzarella|parmesan|cheddar)/i, alg: 'lactosa' },
  { k: /(huevo|tortilla|mayonesa|alioli|huevos)/i, alg: 'huevo' },
  { k: /(almendra|nuez|avellana|pistacho|cacahuete|anacardo|nueces|frutos\s*secos)/i, alg: 'frutos secos' },
  { k: /(gamba|langostin|camar√≥n|marisc)/i, alg: 'marisco' },
  { k: /(at[√∫u]n|bonito|salm[o√≥]n|bacalao|merluza|anchoa|sardina|pescad)/i, alg: 'pescado' },
  { k: /(soja|tamari|tofu|edamame)/i, alg: 'soja' },
  { k: /(s[√©e]sam|ajonjol[i√≠])/i, alg: 'sesamo' },
  { k: /(apio)/i, alg: 'apio' },
  { k: /(mostaza|dijon)/i, alg: 'mostaza' },
  ];
  const $ = (s, c=document)=>c.querySelector(s);
  const $$ = (s, c=document)=>Array.from(c.querySelectorAll(s));
  $('#btn-sugerir').addEventListener('click', ()=>{
    const texto = (($('[name="nombre"]').value||'')+' '+($('[name="descripcion"]').value||'')).toLowerCase();
    $$('#form-edit input[name="alergenos"]').forEach(ch => ch.checked=false);
    reglas.forEach(r=>{
      if(r.k.test(texto)){
        const i = $(`#form-edit input[name="alergenos"][value="${r.alg}"]`);
        if(i) i.checked = true;
      }
    });
  });
  $('#btn-limpiar').addEventListener('click', ()=> $$('#form-edit input[name="alergenos"]').forEach(ch => ch.checked=false));
</script>
{% endblock %}
