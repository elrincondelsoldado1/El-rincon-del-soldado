{% extends "base.html" %}
{% block title %}Añadir producto{% endblock %}

{% block extra_head %}
<style>
  .pill-check{display:none;}
  .pill-label{
    display:inline-flex;align-items:center;gap:.4rem;
    border:1px solid rgba(212,175,55,.35);background:rgba(212,175,55,.08);
    color:#f5f5f5;border-radius:999px;padding:.35rem .65rem;font-size:.9rem;cursor:pointer;
  }
  .pill-check:checked + .pill-label{
    background:linear-gradient(to right,#7a6600,#d4af37);color:#121212;border-color:#d4af37;
  }
  .allergen-badge{
    display:inline-flex;align-items:center;justify-content:center;
    width:22px;height:22px;border-radius:999px;border:1px solid var(--primary,#d4af37);
    background:rgba(212,175,55,.10);color:#f5f5f5;font-size:.85rem;line-height:1;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <h1 class="text-gold fw-bold mb-4">Añadir producto</h1>

  <form method="POST" enctype="multipart/form-data" class="auth-form" id="form-new">
    <div class="mb-3">
      <label class="input-label">Categoría</label>
      <select name="categoria" class="form-select" required>
        {% for c in categorias %}
          <option value="{{ c }}">{{ c }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label class="input-label">Nombre</label>
      <input type="text" name="nombre" class="form-control" required>
    </div>

    <div class="mb-3">
      <label class="input-label">Descripción</label>
      <textarea name="descripcion" class="form-control" rows="4"></textarea>
    </div>

    <div class="mb-3">
      <label class="input-label">Precio (€)</label>
      <input type="number" step="0.01" min="0" name="precio" class="form-control" required>
    </div>

    <div class="mb-4">
      <label class="input-label d-block">Imagen</label>
      <input type="file" name="imagen" accept="image/*" class="form-control" required>
      <div class="form-text">Imagen obligatoria (png, jpg, jpeg, webp o gif).</div>
    </div>

    <!-- Alérgenos -->
    <div class="mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <label class="input-label m-0">Alérgenos</label>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-sm btn-warning" id="btn-sugerir">Sugerir</button>
          <button type="button" class="btn btn-sm btn-secondary" id="btn-limpiar">Limpiar</button>
        </div>
      </div>
      <div class="d-flex flex-wrap gap-2">
        {% for a in alergenos %}
          <input class="pill-check" type="checkbox" id="alg_{{ loop.index }}" name="alergenos" value="{{ a }}">
          <label class="pill-label" for="alg_{{ loop.index }}">
            <span class="allergen-badge">
              {% set k=a|lower %}
              {% if k=='gluten' %}🌾{% elif k=='lactosa' %}🥛{% elif k=='huevo' %}🥚
              {% elif k=='frutos secos' %}🥜{% elif k=='marisco' %}🦐{% elif k=='pescado' %}🐟
              {% elif k=='soja' %}🫘{% elif k=='sesamo' %}SE{% elif k=='apio' %}🥬{% elif k=='mostaza' %}MO{% else %}!{% endif %}
            </span>
            <span>{{ a|title }}</span>
          </label>
        {% endfor %}
      </div>
    </div>

    <!-- Estado -->
    <div class="mb-3">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="sw-agotado" name="agotado">
        <label class="form-check-label" for="sw-agotado">Marcar como Agotado</label>
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="sw-visible" name="visible" checked>
        <label class="form-check-label" for="sw-visible">Visible en la carta</label>
      </div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-military">Crear</button>
      <a href="{{ url_for('admin_index', seccion='carta') }}" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>
</div>

<script>
  const reglas = [
    { k: /(pan|harina|rebozad|masa|pasta|gnocchi|pizza|empanad|gallet|bizcocho|trigo|cebada|centeno)/i, alg: 'gluten' },
    { k: /(queso|leche|nata|mantequilla|yogur|lactosa|bechamel|mozzarella|parmesan|cheddar)/i, alg: 'lactosa' },
    { k: /(huevo|tortilla|mayonesa|alioli|huevos)/i, alg: 'huevo' },
    { k: /(almendra|nuez|avellana|pistacho|cacahuete|anacardo|nueces|frutos\s*secos)/i, alg: 'frutos secos' },
    { k: /(gamba|langostin|camarón|marisc)/i, alg: 'marisco' },
    { k: /(at[úu]n|bonito|salm[oó]n|bacalao|merluza|anchoa|sardina|pescad)/i, alg: 'pescado' },
    { k: /(soja|tamari|tofu|edamame)/i, alg: 'soja' },
    { k: /(s[ée]sam|ajonjol[ií])/i, alg: 'sesamo' },
    { k: /(apio)/i, alg: 'apio' },
    { k: /(mostaza|dijon)/i, alg: 'mostaza' },
  ];
  const $ = (s, c=document)=>c.querySelector(s);
  const $$ = (s, c=document)=>Array.from(c.querySelectorAll(s));
  $('#btn-sugerir').addEventListener('click', ()=>{
    const texto = ((($('[name="nombre"]')||{}).value||'')+' '+(($('[name="descripcion"]')||{}).value||'')).toLowerCase();
    $$('#form-new input[name="alergenos"]').forEach(ch => ch.checked=false);
    reglas.forEach(r=>{
      if(r.k.test(texto)){
        const i=$(`#form-new input[name="alergenos"][value="${r.alg}"]`);
        if(i) i.checked=true;
      }
    });
  });
  $('#btn-limpiar').addEventListener('click', ()=> $$('#form-new input[name="alergenos"]').forEach(ch => ch.checked=false));
</script>
{% endblock %}
