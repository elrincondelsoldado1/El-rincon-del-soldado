{% extends "base.html" %}
{% block title %}Mi perfil{% endblock %}

{% block extra_head %}
<style>
  /* ====== Pestañas estilo admin (doradas con caja) ====== */
  .tabs-gold {
    gap: 14px;
    flex-wrap: wrap;
  }
  .tabs-gold .nav-link{
    border:1px solid rgba(212,175,55,.25);
    color:#eee;
    background:rgba(0,0,0,.18);
    border-radius:18px;
    padding:.55rem 1.1rem;
    transition:.2s;
  }
  .tabs-gold .nav-link:hover{
    border-color:rgba(212,175,55,.45);
    box-shadow:0 0 0 .15rem rgba(212,175,55,.18);
  }
  .tabs-gold .nav-link.active{
    background: linear-gradient(180deg,#e0b84f,#c79a34);
    color:#1b1d1f !important;
    border-color:#d4af37;
    box-shadow:0 6px 18px rgba(240,194,75,.22) inset, 0 0 0 .15rem rgba(212,175,55,.18);
  }
  
  /* ====== Tarjeta translúcida estilo “Contacto” ====== */
  .panel-gold{
    background: rgba(26,26,26,.85);
    border:1px solid rgba(212,175,55,.35);
    border-radius:18px;
    box-shadow:0 0 38px rgba(240,194,75,.16);
    padding:1.25rem;
  }
  
  /* Campos e inputs dorados */
  .form-gold .form-label{ color:#d4af37; font-weight:600; }
  .form-gold .form-control,
  .form-gold .form-select,
  .form-gold textarea{
    background: rgba(0,0,0,.35);
    border:1px solid rgba(212,175,55,.25);
    color:#f5f5f5;
    border-radius:12px;
  }
  .form-gold .form-control::placeholder{ color:#a8a8a8; }
  .form-gold .form-control:focus,
  .form-gold .form-select:focus{
    border-color:#d4af37;
    box-shadow:0 0 0 .2rem rgba(212,175,55,.23);
    background: rgba(0,0,0,.45);
    color:#fff;
    outline:0;
  }
  
  /* Botón dorado consistente */
  .btn-gold{
    background: linear-gradient(180deg,#e0b84f,#c79a34);
    color:#1b1d1f;
    border:1px solid #d4af37;
    font-weight:700;
    border-radius:12px;
  }
  .btn-gold:hover{ filter:brightness(.96); color:#1b1d1f; }
  
  /* Tablas responsive (favoritos/pedidos) */
  .rtable thead th{ vertical-align: middle; color:#d4af37; }
  @media (max-width: 992px){
    .rtable thead{ display:none; }
    .rtable tbody tr{
      display:block; margin:0 0 1rem 0; padding:.6rem;
      border:1px solid rgba(212,175,55,.20); border-radius:14px; background: rgba(0,0,0,.15);
    }
    .rtable tbody td{
      display:flex; justify-content:space-between; align-items:center;
      gap:1rem; border:0 !important; padding:.45rem .75rem;
    }
    .rtable tbody td[data-label]::before{
      content: attr(data-label); font-weight:700; color:#d4af37; margin-right:.75rem;
    }
    .rtable tbody td.text-end{ justify-content:flex-end; }
    .rtable tbody td.text-center{ justify-content:center; }
  }
  
  /* Celdas de imagen (favoritos) */
  .fav-img{
    width:56px; height:56px; border-radius:10px; object-fit:cover;
    border:1px solid rgba(212,175,55,.28); background:#111;
  }
  
  /* Email mostrado con buen contraste */
  .user-email{
    color:#e9e9e9;
  }
  .user-email small{ color:#c9b06b; }
  
  .perfil-pedidos .table tbody tr { border-top-color: transparent !important; }
  
  @media (max-width: 992px){
    .rtable tbody td[data-label="Acciones"]{
      justify-content: center; /* centra el contenido en móvil */
    }
  }
  
  /* Favoritos (perfil): deja solo el recuadro exterior */
  .fav-outer .panel-gold:not(.fav-outer),
  .fav-outer .table-responsive {
    border: 0 !important;
    box-shadow: none !important;
  }
  
  /* ===== SOLO PERFIL: Favoritos + Pedidos ===== */
  .fav-table thead tr > th,
  .ord-table thead tr > th{
    border-bottom: 2px solid rgba(212,175,55,.75) !important; /* fuerte bajo encabezado */
  }
  
  /* Quita cualquier borde/efecto grueso que meta el tema entre filas */
  .fav-table tbody tr,
  .ord-table tbody tr{
    border: 0 !important;
    box-shadow: none !important;
    outline: none !important;
  }
  
  /* Separadores de filas SUAVES (aplicados a las celdas) */
  .fav-table tbody tr > td,
  .ord-table tbody tr > td{
    border-top: 1px solid rgba(212,175,55,.18) !important; /* suave */
  }
  
  /* Por si Bootstrap está metiendo un color más fuerte en celdas “oscura” */
  .table-dark.fav-table tbody tr > td,
  .table-dark.ord-table tbody tr > td{
    --bs-border-color: rgba(212,175,55,.18) !important;
    border-color: rgba(212,175,55,.18) !important;
  }
  
  /* La primera fila del cuerpo no debe heredar un borde fuerte */
  .fav-table tbody tr:first-child > td,
  .ord-table tbody tr:first-child > td{
    border-top: 1px solid rgba(212,175,55,.18) !important;
  }
  
  
</style>
{% endblock %}

{% block content %}
<div class="container py-3">
  
  <h1 class="text-gold fw-bold mb-3">Mi perfil</h1>
  
  <!-- Pestañas -->
  <ul class="nav tabs-gold mb-3">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-datos">Datos de cuenta</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-favoritos">Favoritos</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-pedidos">Pedidos</a></li>
  </ul>
  
  <div class="tab-content">
    
    <!-- ================= DATOS ================= -->
    <div class="tab-pane fade show active" id="tab-datos">
      <div class="row g-3">
        <!-- Datos básicos -->
        <div class="col-lg-7">
          <div class="panel-gold form-gold h-100">
            <h5 class="text-gold fw-bold mb-3">Información básica</h5>
            <form method="post" action="{{ url_for('perfil_datos') }}">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Nombre</label>
                  <input class="form-control" name="nombre" value="{{ user.nombre }}">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Teléfono</label>
                  <input class="form-control" name="telefono" value="{{ (perfil.telefono or '') }}">
                </div>
                
                <div class="col-12">
                  <label class="form-label">Dirección</label>
                  <input class="form-control" name="direccion" value="{{ (perfil.direccion or '') }}">
                </div>
                
                <div class="col-md-6">
                  <label class="form-label">Ciudad</label>
                  <input class="form-control" name="ciudad" value="{{ (perfil.ciudad or '') }}">
                </div>
                
                <div class="col-md-6">
                  <label class="form-label">Método de pago preferido</label>
                  {% set m = (perfil.metodo_pago_pref or '') %}
                  <select class="form-select" name="metodo_pago_pref">
                    <option value="">—</option>
                    <option value="stripe"   {{ 'selected' if m=='stripe' else '' }}>Tarjeta (Stripe)</option>
                    <option value="paypal"   {{ 'selected' if m=='paypal' else '' }}>PayPal</option>
                    <option value="efectivo" {{ 'selected' if m=='efectivo' else '' }}>Efectivo</option>
                  </select>
                </div>
                
                <div class="col-md-6">
                  <label class="form-label">Alias de pago (ej. “Visa personal”)</label>
                  <input class="form-control" name="pago_alias" value="{{ (perfil.pago_alias or '') }}">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Últimos 4 dígitos (opcional)</label>
                  <input class="form-control" name="pago_last4" maxlength="4" value="{{ (perfil.pago_last4 or '') }}">
                </div>
              </div>
              
              <div class="mt-3 d-flex gap-2">
                <button class="btn btn-gold">Guardar cambios</button>
              </div>
            </form>
          </div>
        </div>
        
        <!-- Cambiar contraseña -->
        <div class="col-lg-5">
          <div class="panel-gold form-gold h-100">
            <h5 class="text-gold fw-bold mb-3">Cambiar contraseña</h5>
            <form method="post" action="{{ url_for('perfil_password') }}">
              <div class="mb-2">
                <label class="form-label">Contraseña actual</label>
                <input type="password" class="form-control" name="password_actual" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Nueva contraseña</label>
                <input type="password" class="form-control" name="password_nueva" minlength="6" required>
              </div>
              <button class="btn btn-gold">Actualizar contraseña</button>
            </form>
            
            <div class="mt-3 user-email">
              <small>Email:</small> {{ user.email }}
            </div>
          </div>
        </div>
        
        <!-- Avatar -->
        <div class="col-12">
          <div class="panel-gold form-gold">
            <h5 class="text-gold fw-bold mb-3">Mi avatar</h5>
            <div class="row g-3 align-items-center">
              <div class="col-sm-3 col-md-2 text-center">
                {% set av = session.get('avatar') or 'img/avatars/default.webp' %}
                <img
                src="{{ av if av.startswith('http') else url_for('static', filename=av) }}"
                alt="Avatar"
                class="img-fluid rounded"
                style="max-width:110px;border:1px solid rgba(212,175,55,35);box-shadow:0 0 16px rgba(240,194,75,12);">
                
              </div>
              <div class="col-sm-9 col-md-10">
                <form method="post" enctype="multipart/form-data" action="{{ url_for('perfil_avatar') }}">
                  <div class="row g-2 align-items-center">
                    <div class="col-md-8">
                      <input class="form-control" type="file" name="avatar" accept=".png,.jpg,.jpeg,.webp,.gif" required>
                    </div>
                    <div class="col-md-4 d-grid">
                      <button class="btn btn-gold">Actualizar avatar</button>
                    </div>
                  </div>
                  <div class="form-text mt-1" style="color:#c9c9c9;">
                    Formatos permitidos: png, jpg, jpeg, webp, gif.
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        
      </div> <!-- /row -->
    </div>
    
    <!-- ================= FAVORITOS ================= -->
     
    <div class="tab-pane fade" id="tab-favoritos">
      {% if favoritos and favoritos|length %}
      <div class="panel-gold fav-outer">
        <div class="table-responsive">
          <table class="table table-dark table-hover align-middle rtable fav-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Imagen</th>
                <th>Categoría</th>
                <th>Producto</th>
                <th class="text-end">Precio (€)</th>
                <th class="text-center">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for p in favoritos %}
              <tr>
                <td data-label="#">{{ p.id }}</td>
                <td data-label="Imagen">
                  {% set img = p.imagen or '' %}
                  {% if img %}
                  <img class="fav-img" src="{{ url_for('static', filename='img/' ~ img) }}" alt="{{ p.nombre }}">
                  {% else %}
                  <div class="fav-img d-flex align-items-center justify-content-center">—</div>
                  {% endif %}
                </td>
                <td data-label="Categoría">{{ p.categoria }}</td>
                <td data-label="Producto" class="fw-semibold">{{ p.nombre }}</td>
                <td data-label="Precio" class="text-end">{{ '%.2f'|format(p.precio|float) }}</td>
                <td data-label="Acciones" class="text-center">
                  <div class="d-flex justify-content-center">
                    <form method="post" action="{{ url_for('favoritos_toggle', pid=p.id) }}" class="m-0">
                      <button class="btn btn-sm btn-outline-danger">Quitar</button>
                    </form>
                  </div>
                </td>
                
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% else %}
      <div class="text-secondary py-4">Aún no tienes favoritos.</div>
      {% endif %}
    </div>
    
    
    {# ====== PEDIDOS ====== #}
    <div class="tab-pane fade" id="tab-pedidos">
      {% if pedidos and pedidos|length %}
      <div class="table-responsive mt-2">
        <table class="table table-dark table-hover align-middle rtable ord-table">
          <thead class="thead-gold">
            <tr>
              <th>Pedido</th>
              <th>Fecha</th>
              <th>Estado</th>
              <th class="text-end">Total (€)</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for o in pedidos %}
            <tr>
              <td data-label="Pedido">{{ o.num_pedido or ('#' ~ o.id) }}</td>
              <td data-label="Fecha">{{ o.creado_en or o.fecha }}</td>
              <td data-label="Estado">
                {% set est = (o.estado or '')|lower %}
                {% set badge = 'bg-light text-dark' %}
                {% if 'pagado' in (o.estado_label or '').lower() %}{% set badge = 'bg-success' %}
                {% elif est == 'pendiente' %}{% set badge = 'bg-warning text-dark' %}
                {% elif est == 'cancelado' %}{% set badge = 'bg-secondary' %}
                {% elif est == 'completado' %}{% set badge = 'bg-success' %}
                {% endif %}
                <span class="badge {{ badge }}">{{ o.estado_label or o.estado }}</span>
              </td>
              
              <td data-label="Total" class="text-end">{{ '%.2f'|format(o.total|float) }}</td>
              <td data-label="Acciones" class="text-center">
                <div class="d-flex justify-content-center w-100">
                  <form method="post"
                  action="{{ url_for('mis_pedidos_eliminar', oid=o.id) }}"
                  class="m-0"
                  onsubmit="return confirm('¿Eliminar el pedido {{ o.num_pedido or ('#' ~ o.id) }}?');">
                  <button class="btn btn-sm btn-outline-danger">Eliminar</button>
                </form>
              </div>
            </td>
            
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-secondary py-4">No hay pedidos todavía.</div>
    {% endif %}
  </div>
  
  
</div> <!-- /tab-content -->
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    if (location.hash) {
      const t = document.querySelector(`a[href="${location.hash}"][data-bs-toggle="tab"]`);
      if (t) new bootstrap.Tab(t).show();
    }
  });
</script>
{% endblock %}
